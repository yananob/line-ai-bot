name: Deploy to Cloud Run
on:
  # push:
  #   branches:
  #     - main # main ブランチへの push でトリガー
  pull_request:
    # branches:
    #   - main # main ブランチへのプルリクエスト作成・更新でトリガー
  workflow_dispatch: # 手動実行を許可

jobs:
  deploy:
    permissions:
      contents: 'read'
      id-token: 'write' # OIDC トークンを取得するために必要
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # (PHPのセットアップ、Composerインストール、テストなどのステップ)

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2 # Google公式の認証アクション
        with:
          # Google Cloud で設定した Workload Identity プロバイダのパス
          workload_identity_provider: 'projects/1035100650942/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
          # 権限を借用するサービスアカウントのメールアドレス
          service_account: 'cloud-run-deployer@nobu5-393106.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: 'line-ai-bot-test' # Cloud Run サービス名
          region: 'us-west1' # デプロイリージョン
          source: '.' # ソースコードのパス
          # image: 'gcr.io/${{ env.PROJECT_ID }}/your-image-name:${{ github.sha }}' # 独自にビルドしたイメージを使う場合
